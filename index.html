<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Snake and Ladder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            touch-action: manipulation;
        }
        #game-board {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            grid-template-rows: repeat(10, 1fr);
        }
        .square {
            position: relative;
            aspect-ratio: 1 / 1;
            display: flex;
            justify-content: flex-start;
            align-items: flex-end;
            font-size: 0.8rem;
            font-weight: 600;
            padding: 4px;
            border: 1px solid rgba(0,0,0,0.1);
        }
        @media (min-width: 640px) { .square { font-size: 1.1rem; } }
        .square:nth-child(even) { background-color: #f0fdf4; }
        .square:nth-child(odd) { background-color: #dcfce7; }
        .player {
            position: absolute;
            width: 5%;
            height: 5%;
            transition: all 0.4s ease-in-out;
            z-index: 10;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        .shape-circle { border-radius: 50%; }
        .shape-square { border-radius: 10%; }
        .shape-diamond { clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%); }
        .shape-star { clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%); }
        #dice-container { perspective: 1000px; }
        #dice { width: 60px; height: 60px; position: relative; transform-style: preserve-3d; transition: transform 1s; }
        .dice-face { position: absolute; width: 60px; height: 60px; background-color: #fff; border: 2px solid #333; border-radius: 8px; display: flex; justify-content: center; align-items: center; font-size: 2rem; font-weight: bold; }
        .face-1 { transform: rotateY(0deg) translateZ(30px); }
        .face-2 { transform: rotateY(90deg) translateZ(30px); }
        .face-3 { transform: rotateY(180deg) translateZ(30px); }
        .face-4 { transform: rotateY(-90deg) translateZ(30px); }
        .face-5 { transform: rotateX(90deg) translateZ(30px); }
        .face-6 { transform: rotateX(-90deg) translateZ(30px); }
        .modal { display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { animation: slide-down 0.5s ease-out; }
        @keyframes slide-down { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #3498db; width: 30px; height: 30px; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-green-100 min-h-screen flex items-center justify-center p-4">

    <div id="loading-overlay" class="fixed inset-0 bg-white/80 z-50 flex flex-col items-center justify-center">
        <div class="loader"></div>
        <p class="mt-4 text-gray-600">Connecting...</p>
    </div>

    <div class="w-full max-w-4xl mx-auto">
        <!-- Setup Screen -->
        <div id="setup-screen" class="bg-white rounded-2xl shadow-2xl p-8 text-center">
            <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold text-green-800 mb-6">Real-time Snake & Ladder</h1>
            
            <div id="initial-options">
                <button id="create-game-btn" class="w-full sm:w-auto mb-4 bg-green-600 text-white font-bold py-3 px-8 rounded-lg text-xl shadow-lg hover:bg-green-700 active:bg-green-800 transform hover:scale-105 transition-all duration-200">
                    Create New Game
                </button>
                <button id="show-join-game-btn" class="w-full sm:w-auto bg-blue-600 text-white font-bold py-3 px-8 rounded-lg text-xl shadow-lg hover:bg-blue-700 active:bg-blue-800 transform hover:scale-105 transition-all duration-200">
                    Join Game
                </button>
            </div>

            <div id="join-game-section" class="hidden mt-4 max-w-sm mx-auto">
                <label for="game-code-input" class="block text-xl text-gray-700 font-semibold mb-2">Enter Game Code</label>
                <input type="text" id="game-code-input" maxlength="6" class="w-full text-center tracking-widest text-2xl p-2 border-2 border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 uppercase">
                <button id="join-game-btn" class="mt-4 bg-blue-600 text-white font-bold py-3 px-8 rounded-lg text-xl shadow-lg hover:bg-blue-700 active:bg-blue-800 transform hover:scale-105 transition-all duration-200">
                    Join
                </button>
                <p id="setup-error" class="text-red-500 text-sm h-4 mt-2"></p>
            </div>
        </div>

        <!-- Lobby Screen (hidden initially) -->
        <div id="lobby-screen" class="hidden bg-white rounded-2xl shadow-2xl p-8 text-center">
            <h2 class="text-2xl font-bold text-gray-700">Game Lobby</h2>
            <p class="text-gray-600 mt-2">Share this code with your friends:</p>
            <div class="my-4 bg-gray-200 text-gray-800 text-4xl font-bold tracking-widest rounded-lg p-4 inline-block cursor-pointer" id="game-code-display" title="Click to copy">
                ------
            </div>
            <p id="copy-feedback" class="text-green-600 h-4"></p>
            <h3 class="text-xl font-semibold mt-6 mb-2">Players Joined:</h3>
            <div id="player-lobby-list" class="space-y-2 min-h-[100px]"></div>
            <button id="start-game-btn" class="mt-6 bg-green-600 text-white font-bold py-3 px-8 rounded-lg text-xl shadow-lg hover:bg-green-700 active:bg-green-800 disabled:opacity-50 disabled:cursor-not-allowed">
                Start Game
            </button>
        </div>


        <!-- Game Screen (hidden initially) -->
        <div id="game-screen" class="hidden bg-white rounded-2xl shadow-2xl p-4 sm:p-6 lg:p-8">
             <div class="flex justify-between items-center mb-4">
                <h1 class="text-2xl sm:text-3xl lg:text-4xl font-bold text-green-800">Snake & Ladder</h1>
                <p class="text-sm text-gray-500 font-mono">Game Code: <span id="game-code-ingame"></span></p>
            </div>
            <div class="flex flex-col lg:flex-row gap-6">
                <div class="w-full lg:w-2/3 aspect-square relative">
                    <div id="game-board" class="w-full h-full border-4 border-green-700 rounded-lg overflow-hidden"></div>
                    <div id="player-pieces" class="absolute top-0 left-0 w-full h-full pointer-events-none"></div>
                </div>
                <div class="w-full lg:w-1/3 flex flex-col items-center justify-center bg-green-50 rounded-lg p-6">
                    <div id="turn-indicator" class="text-2xl font-bold mb-4 p-3 rounded-lg w-full text-center transition-colors duration-300">Player 1's Turn</div>
                    <div id="dice-container" class="my-6">
                        <div id="dice">
                            <div class="dice-face face-1">1</div><div class="dice-face face-2">2</div><div class="dice-face face-3">3</div>
                            <div class="dice-face face-4">4</div><div class="dice-face face-5">5</div><div class="dice-face face-6">6</div>
                        </div>
                    </div>
                    <button id="roll-dice-btn" class="bg-green-600 text-white font-bold py-3 px-8 rounded-lg text-xl shadow-lg hover:bg-green-700 active:bg-green-800 active:shadow-inner transform hover:scale-105 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                        Roll Dice
                    </button>
                    <div id="message-log" class="mt-6 text-center text-gray-600 font-semibold h-12">Waiting for game to start...</div>
                    <button id="reset-btn" class="mt-4 bg-gray-500 text-white font-bold py-2 px-6 rounded-lg shadow hover:bg-gray-600 active:bg-gray-700 transition-colors">
                        New Game
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Winner Modal -->
    <div id="winner-modal" class="modal">
        <div class="modal-content bg-white p-8 rounded-2xl shadow-2xl text-center max-w-sm w-full">
            <h2 id="winner-message" class="text-4xl font-bold text-yellow-500 mb-4">Player 1 Wins!</h2>
            <p class="text-lg text-gray-700 mb-6">Congratulations!</p>
            <button id="play-again-btn" class="bg-green-600 text-white font-bold py-3 px-8 rounded-lg text-xl shadow-lg hover:bg-green-700 active:bg-green-800 transform hover:scale-105 transition-all duration-200">
                Play Again
            </button>
        </div>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, runTransaction, setLogLevel, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = {
  apiKey: "AIzaSyBfxA8x7-h9dVitv0bG72EINYjh5l5jnDY",
  authDomain: "snake-ladder-5800f.firebaseapp.com",
  databaseURL: "https://snake-ladder-5800f-default-rtdb.firebaseio.com",
  projectId: "snake-ladder-5800f",
  storageBucket: "snake-ladder-5800f.firebasestorage.app",
  messagingSenderId: "943719213840",
  appId: "1:943719213840:web:e624c86ab9d30be48a1395",
  measurementId: "G-CHLPD6VBVP"
};
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        setLogLevel('debug');

        // --- DOM Elements ---
        const loadingOverlay = document.getElementById('loading-overlay');
        const setupScreen = document.getElementById('setup-screen');
        const lobbyScreen = document.getElementById('lobby-screen');
        const gameScreen = document.getElementById('game-screen');
        const createGameBtn = document.getElementById('create-game-btn');
        const showJoinGameBtn = document.getElementById('show-join-game-btn');
        const joinGameSection = document.getElementById('join-game-section');
        const gameCodeInput = document.getElementById('game-code-input');
        const joinGameBtn = document.getElementById('join-game-btn');
        const setupError = document.getElementById('setup-error');
        const gameCodeDisplay = document.getElementById('game-code-display');
        const playerLobbyList = document.getElementById('player-lobby-list');
        const startGameBtn = document.getElementById('start-game-btn');
        const gameBoard = document.getElementById('game-board');
        const playerPiecesContainer = document.getElementById('player-pieces');
        const rollDiceBtn = document.getElementById('roll-dice-btn');
        const resetBtn = document.getElementById('reset-btn');
        const turnIndicator = document.getElementById('turn-indicator');
        const messageLog = document.getElementById('message-log');
        const diceElement = document.getElementById('dice');
        const winnerModal = document.getElementById('winner-modal');
        const winnerMessage = document.getElementById('winner-message');
        const playAgainBtn = document.getElementById('play-again-btn');
        const copyFeedback = document.getElementById('copy-feedback');
        const gameCodeIngame = document.getElementById('game-code-ingame');

        // --- Game Constants ---
        const BOARD_SIZE = 100;
        const PLAYER_CONFIG = [
            { color: '#ef4444', shape: 'shape-circle', indicator: 'bg-red-100 text-red-800' },
            { color: '#3b82f6', shape: 'shape-square', indicator: 'bg-blue-100 text-blue-800' },
            { color: '#facc15', shape: 'shape-diamond', indicator: 'bg-yellow-100 text-yellow-800' },
            { color: '#22c55e', shape: 'shape-star', indicator: 'bg-green-100 text-green-800' },
        ];

        // --- Game State ---
        let userId = null;
        let currentGameCode = null;
        let gameUnsubscribe = null; // To detach Firestore listener

        // --- Firestore Path Helper ---
        function getGameDocRef(gameCode) {
            return doc(db, "artifacts", appId, "public", "data", "games", gameCode);
        }
        
        // --- Authentication ---
        async function initializeAuth() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("User authenticated with UID:", userId);
                    loadingOverlay.style.display = 'none';
                }
            });

            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication failed:", error);
                loadingOverlay.innerHTML = `<p class="text-red-500 font-bold p-4">Authentication Failed. Please check your setup or refresh the page.</p>`;
            }
        }
        
        // --- Core Functions ---
        
        async function createGame() {
            createGameBtn.disabled = true;
            const gameCode = await generateUniqueGameCode();
            const hostPlayer = {
                uid: userId,
                id: 1,
                position: 0,
                config: PLAYER_CONFIG[0]
            };
            
            const gameData = {
                code: gameCode,
                players: [hostPlayer],
                currentPlayerIndex: 0,
                status: 'lobby', // lobby, active, finished
                lastDiceRoll: 1,
                logMessage: 'Waiting for players to join...',
                winnerId: null,
                hostId: userId,
            };

            await setDoc(getGameDocRef(gameCode), gameData);
            joinLobby(gameCode);
        }
        
        async function joinGame() {
            const gameCode = gameCodeInput.value.toUpperCase();
            if (gameCode.length !== 6) {
                setupError.textContent = "Code must be 6 characters.";
                return;
            }
            setupError.textContent = "";
            joinGameBtn.disabled = true;

            const gameRef = getGameDocRef(gameCode);
            try {
                await runTransaction(db, async (transaction) => {
                    const gameDoc = await transaction.get(gameRef);
                    if (!gameDoc.exists()) {
                        throw new Error("Game not found.");
                    }
                    
                    const gameData = gameDoc.data();
                    if (gameData.players.length >= 4) {
                        throw new Error("Game is full.");
                    }
                    if (gameData.status !== 'lobby') {
                        throw new Error("Game has already started.");
                    }
                    if (gameData.players.some(p => p.uid === userId)) {
                        // Player is already in, just join
                        return;
                    }
                    
                    const newPlayer = {
                        uid: userId,
                        id: gameData.players.length + 1,
                        position: 0,
                        config: PLAYER_CONFIG[gameData.players.length]
                    };
                    
                    const newPlayers = [...gameData.players, newPlayer];
                    transaction.update(gameRef, { players: newPlayers });
                });
                joinLobby(gameCode);
            } catch (error) {
                setupError.textContent = error.message;
                joinGameBtn.disabled = false;
            }
        }
        
        function joinLobby(gameCode) {
            currentGameCode = gameCode;
            setupScreen.classList.add('hidden');
            lobbyScreen.classList.remove('hidden');
            gameCodeDisplay.textContent = gameCode;
            gameCodeIngame.textContent = gameCode;

            gameUnsubscribe = onSnapshot(getGameDocRef(gameCode), (doc) => {
                if (doc.exists()) {
                    renderGameState(doc.data());
                } else {
                    alert("Game session ended.");
                    leaveGame();
                }
            });
        }
        
        async function startGame() {
            if (!currentGameCode) return;
            await updateDoc(getGameDocRef(currentGameCode), {
                status: 'active',
                logMessage: 'Roll a 6 to start!'
            });
        }

        async function handleRollDice() {
            if (!currentGameCode) return;
            
            rollDiceBtn.disabled = true;
            const roll = Math.floor(Math.random() * 6) + 1;
            
            const gameRef = getGameDocRef(currentGameCode);

            try {
                await runTransaction(db, async (transaction) => {
                    const gameDoc = await transaction.get(gameRef);
                    if (!gameDoc.exists()) throw new Error("Game not found.");
                    
                    let data = gameDoc.data();
                    const currentPlayer = data.players[data.currentPlayerIndex];
                    let log = `Player ${currentPlayer.id} rolled a ${roll}!`;
                    let newPosition = currentPlayer.position;

                    if (currentPlayer.position === 0 && roll !== 6) {
                        log = `Player ${currentPlayer.id} needs a 6 to start.`;
                    } else {
                        if (currentPlayer.position === 0 && roll === 6) {
                           newPosition = 1;
                           log = `Player ${currentPlayer.id} is on the board!`;
                        } else {
                            newPosition += roll;
                        }
                        
                        if (newPosition > BOARD_SIZE) {
                            log = `Too high! Must land on 100.`;
                            newPosition = currentPlayer.position; // Don't move
                        }
                    }

                    data.players[data.currentPlayerIndex].position = newPosition;
                    
                    let winner = null;
                    if (newPosition === BOARD_SIZE) {
                        winner = currentPlayer.id;
                        data.status = 'finished';
                    }

                    // Switch turn
                    const nextPlayerIndex = (data.currentPlayerIndex + 1) % data.players.length;

                    transaction.update(gameRef, {
                        lastDiceRoll: roll,
                        players: data.players,
                        logMessage: log,
                        currentPlayerIndex: nextPlayerIndex,
                        status: data.status,
                        winnerId: winner
                    });
                });
            } catch(e) {
                console.error("Roll dice transaction failed:", e);
                rollDiceBtn.disabled = false; // re-enable on error
            }
        }

        function leaveGame() {
            if (gameUnsubscribe) {
                gameUnsubscribe();
                gameUnsubscribe = null;
            }
            currentGameCode = null;
            
            gameScreen.classList.add('hidden');
            lobbyScreen.classList.add('hidden');
            winnerModal.style.display = 'none';
            setupScreen.classList.remove('hidden');
            joinGameSection.classList.add('hidden');
            createGameBtn.disabled = false;
            joinGameBtn.disabled = false;
            gameCodeInput.value = '';
        }
        
        // --- Rendering ---
        
        function renderGameState(data) {
            if (data.status === 'lobby') {
                renderLobby(data);
            } else {
                if (lobbyScreen.style.display !== 'none') {
                    lobbyScreen.classList.add('hidden');
                    gameScreen.classList.remove('hidden');
                }
                renderGame(data);
            }
        }
        
        function renderLobby(data) {
            playerLobbyList.innerHTML = '';
            data.players.forEach(p => {
                const playerDiv = document.createElement('div');
                playerDiv.className = `p-2 rounded-lg flex items-center justify-center mx-auto max-w-xs ${p.config.indicator}`;
                playerDiv.innerHTML = `<span class="w-4 h-4 mr-3 ${p.config.shape}" style="background-color: ${p.config.color};"></span> Player ${p.id} ${p.uid === userId ? '(You)' : ''}`;
                playerLobbyList.appendChild(playerDiv);
            });
            
            startGameBtn.disabled = !(data.hostId === userId && data.players.length >= 1); // Allow starting with 1 player for testing
        }

        function renderGame(data) {
            // Update player pieces
            playerPiecesContainer.innerHTML = '';
            data.players.forEach(p => {
                const playerElement = document.createElement('div');
                playerElement.className = `player ${p.config.shape}`;
                playerElement.textContent = `P${p.id}`;
                playerElement.style.backgroundColor = p.config.color;
                playerPiecesContainer.appendChild(playerElement);
                updatePlayerPosition(p, playerElement);
            });
            
            // Update turn indicator
            const currentPlayer = data.players[data.currentPlayerIndex];
            turnIndicator.textContent = `Player ${currentPlayer.id}'s Turn`;
            turnIndicator.className = `text-2xl font-bold mb-4 p-3 rounded-lg w-full text-center transition-colors duration-300 ${currentPlayer.config.indicator}`;

            // Update Log
            messageLog.textContent = data.logMessage;
            
            // Animate Dice
            animateDice(data.lastDiceRoll);

            // Enable/disable roll button
            rollDiceBtn.disabled = (currentPlayer.uid !== userId || data.status !== 'active');

            // Check for winner
            if (data.status === 'finished') {
                winnerMessage.textContent = `Player ${data.winnerId} Wins!`;
                winnerModal.style.display = 'flex';
                rollDiceBtn.disabled = true;
            } else {
                 winnerModal.style.display = 'none';
            }
        }

        function updatePlayerPosition(player, element) {
            const { id, position } = player;
            if (position === 0) {
                element.style.bottom = `-10%`;
                element.style.left = `${5 + (id-1) * 7}%`;
                return;
            }
            const targetSquare = document.querySelector(`[data-square='${position}']`);
            if (!targetSquare) return;
            const boardRect = gameBoard.getBoundingClientRect();
            const squareRect = targetSquare.getBoundingClientRect();
            const yOffset = (boardRect.bottom - squareRect.bottom) / boardRect.height * 100;
            const xOffset = (squareRect.left - boardRect.left) / boardRect.width * 100;
            element.style.bottom = `${yOffset}%`;
            element.style.left = `${xOffset + (id * 1.5)}%`;
        }
        
        function animateDice(roll) {
            const rotations = { 1: 'rotateY(0deg)', 2: 'rotateY(-90deg)', 3: 'rotateY(-180deg)', 4: 'rotateY(90deg)', 5: 'rotateX(-90deg)', 6: 'rotateX(90deg)' };
            const randomX = (Math.floor(Math.random() * 2) + 1) * 360;
            const randomY = (Math.floor(Math.random() * 2) + 1) * 360;
            diceElement.style.transform = `rotateX(${randomX}deg) rotateY(${randomY}deg) ${rotations[roll]}`;
        }
        
        // --- Utility ---
        
        async function generateUniqueGameCode() {
            let code;
            let exists = true;
            const gamesCollectionRef = collection(db, "artifacts", appId, "public", "data", "games");
            while(exists) {
                code = Math.random().toString(36).substring(2, 8).toUpperCase();
                const gameDocRef = doc(gamesCollectionRef, code);
                const docSnap = await getDoc(gameDocRef);
                exists = docSnap.exists();
            }
            return code;
        }

        function createBoard() {
            gameBoard.innerHTML = '';
            const fragment = document.createDocumentFragment();
            for (let i = BOARD_SIZE; i >= 1; i--) {
                const square = document.createElement('div');
                square.className = 'square';
                square.dataset.square = i;
                square.appendChild(document.createElement('span')).textContent = i;
                fragment.appendChild(square);
            }
            gameBoard.appendChild(fragment);
            const squares = Array.from(gameBoard.children);
            const correctedOrder = [];
            for(let row = 0; row < 10; row++) {
                const rowSquares = squares.slice(row * 10, (row + 1) * 10);
                if(row % 2 === 1) rowSquares.reverse();
                correctedOrder.push(...rowSquares);
            }
            gameBoard.innerHTML = '';
            correctedOrder.forEach(square => gameBoard.appendChild(square));
        }

        // --- Event Listeners ---
        createGameBtn.addEventListener('click', createGame);
        showJoinGameBtn.addEventListener('click', () => joinGameSection.classList.remove('hidden'));
        joinGameBtn.addEventListener('click', joinGame);
        startGameBtn.addEventListener('click', startGame);
        rollDiceBtn.addEventListener('click', handleRollDice);
        resetBtn.addEventListener('click', leaveGame);
        playAgainBtn.addEventListener('click', () => {
             // For now, just leaves game. A "play again" feature would need more logic.
             leaveGame();
        });
        gameCodeDisplay.addEventListener('click', () => {
            if(currentGameCode) {
                navigator.clipboard.writeText(currentGameCode).then(() => {
                    copyFeedback.textContent = 'Copied!';
                    setTimeout(() => copyFeedback.textContent = '', 2000);
                });
            }
        });
        
        // --- Initial Setup ---
        createBoard();
        initializeAuth();

    </script>
</body>
</html>

